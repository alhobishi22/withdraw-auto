<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุชุญูู | ุจูุช ุงูุชุญูููุงุช</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- ุงููุงุฆูุฉ ุงูุนูููุฉ -->
    <nav class="bg-gray-800 text-white">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <a href="/" class="px-3 py-2">ุงูุฑุฆูุณูุฉ</a>
                    <a href="/transfers" class="px-3 py-2">ุงูุนูููุงุช</a>
                    <a href="#codes" class="px-3 py-2">ุฅุฏุงุฑุฉ ุงูุฃููุงุฏ</a>
                    <a href="#settings" class="px-3 py-2">ุงูุฅุนุฏุงุฏุงุช</a>
                </div>
                <div>
                    <span>ููุญุฉ ุงูุชุญูู</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ููุญุฉ ุงููุนูููุงุช -->
    <div class="max-w-7xl mx-auto mt-6 px-4">
        <!-- ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู -->
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4">ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏููู</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-blue-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ุฅุฌูุงูู ุงููุณุชุฎุฏููู</h3>
                    <p class="text-3xl font-bold">{{ stats.total_users }}</p>
                    <p class="text-sm mt-2">ูุดุท: {{ stats.active_users }}</p>
                </div>
                
                <div class="bg-green-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ูุณุชุฎุฏููู ุฌุฏุฏ ุงูููู</h3>
                    <p class="text-3xl font-bold">{{ stats.new_users_today }}</p>
                </div>
                
                <div class="bg-purple-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ูุดุท ุงูููู</h3>
                    <p class="text-3xl font-bold">{{ stats.active_users_today }}</p>
                </div>
                
                <div class="bg-indigo-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ูุนุฏู ุงููุดุงุท</h3>
                    <p class="text-3xl font-bold">{{ "%.1f"|format(stats.active_users_today / stats.total_users * 100) if stats.total_users > 0 else 0 }}%</p>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงูุฃููุงุฏ -->
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4">ุฅุญุตุงุฆูุงุช ุฃููุงุฏ ุงูุชุณุฌูู</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-green-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ุฅุฌูุงูู ุงูุฃููุงุฏ</h3>
                    <p class="text-3xl font-bold">{{ stats.total_codes }}</p>
                    <p class="text-sm mt-2">ูุดุท: {{ stats.active_codes }}</p>
                </div>
                
                <div class="bg-blue-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ุฃููุงุฏ ุฌุฏูุฏุฉ ุงูููู</h3>
                    <p class="text-3xl font-bold">{{ stats.new_codes_today }}</p>
                </div>
                
                <div class="bg-yellow-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ุฅุฌูุงูู ุงูุงุณุชุฎุฏุงู</h3>
                    <p class="text-3xl font-bold">{{ stats.total_code_uses }}</p>
                </div>
                
                <div class="bg-purple-500 text-white rounded-lg p-6">
                    <h3 class="text-lg mb-2">ูุนุฏู ุงูุงุณุชุฎุฏุงู</h3>
                    <p class="text-3xl font-bold">{{ "%.1f"|format(stats.total_code_uses / stats.total_codes) if stats.total_codes > 0 else 0 }}</p>
                    <p class="text-sm mt-2">ููู ููุฏ</p>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงูุนูููุงุช -->
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4">ุฅุญุตุงุฆูุงุช ุงูุนูููุงุช</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">ุงูุนูููุงุช ุงูููุชููุฉ</h3>
                        <span class="text-green-500 text-2xl font-bold">{{ stats.completed_transfers }}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <p>ุงูููู: {{ stats.completed_today }}</p>
                        <p>ุงููุจูุบ: {{ "%.2f"|format(stats.total_amount) }} USDT</p>
                        <p>ูุนุฏู ุงูุนูููุฉ: {{ "%.2f"|format(stats.avg_amount) }} USDT</p>
                    </div>
                    <a href="/transfers?status=completed" class="text-green-500 hover:text-green-600">ุนุฑุถ ุงูุชูุงุตูู โ</a>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">ุงูุนูููุงุช ุงููุนููุฉ</h3>
                        <span class="text-yellow-500 text-2xl font-bold">{{ stats.pending_transfers }}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <p>ุงูููู: {{ stats.today_operations }}</p>
                    </div>
                    <a href="/transfers?status=pending" class="text-yellow-500 hover:text-yellow-600">ุนุฑุถ ุงูุชูุงุตูู โ</a>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">ุงูุนูููุงุช ุงููุฑููุถุฉ</h3>
                        <span class="text-red-500 text-2xl font-bold">{{ stats.rejected_transfers }}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <p>ูุณุจุฉ ุงูุฑูุถ: {{ "%.1f"|format(stats.rejected_transfers / stats.total_transfers * 100) if stats.total_transfers > 0 else 0 }}%</p>
                    </div>
                    <a href="/transfers?status=rejected" class="text-red-500 hover:text-red-600">ุนุฑุถ ุงูุชูุงุตูู โ</a>
                </div>
            </div>
        </div>

        <!-- ุฅุญุตุงุฆูุงุช ุงูุนููุงุช -->
        <div class="mb-8">
            <h2 class="text-xl font-bold mb-4">ุฅุญุตุงุฆูุงุช ุญุณุจ ุงูุนููุฉ</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {% for stat in stats.currency_stats %}
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">{{ stat.currency }}</h3>
                        <span class="text-blue-500 text-2xl font-bold">{{ stat.total_transfers }}</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p>ุฅุฌูุงูู ุงููุจูุบ: {{ "%.2f"|format(stat.total_amount) }} USDT</p>
                        <p>ูุนุฏู ุงูุนูููุฉ: {{ "%.2f"|format(stat.total_amount / stat.total_transfers) if stat.total_transfers > 0 else 0 }} USDT</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ุฅุฏุงุฑุฉ ุงูุฃููุงุฏ -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">ุฅุฏุงุฑุฉ ุงูุฃููุงุฏ</h2>
                <div class="flex space-x-4 space-x-reverse">
                    <button onclick="document.getElementById('importFile').click()" class="bg-green-500 text-white px-4 py-2 rounded-md">
                        ุงุณุชูุฑุงุฏ ูู Excel
                    </button>
                    <a href="/export-codes" class="bg-blue-500 text-white px-4 py-2 rounded-md inline-block">
                        ุชุตุฏูุฑ ุฅูู Excel
                    </a>
                    <button onclick="showCodeModal()" class="bg-blue-500 text-white px-4 py-2 rounded-md">
                        ุฅุถุงูุฉ ููุฏ ุฌุฏูุฏ
                    </button>
                </div>
            </div>
            
            <!-- ูููุฐุฌ ุงุณุชูุฑุงุฏ ุงูููู (ูุฎูู) -->
            <input type="file" id="importFile" accept=".xlsx" class="hidden" onchange="importCodes(this)">

            <!-- ุฑุณุงูุฉ ุงููุฌุงุญ/ุงูุฎุทุฃ -->
            <div id="importMessage" class="hidden mb-4"></div>
            
            {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">ุฎุทุฃ!</strong>
                <span class="block sm:inline">{{ error }}</span>
            </div>
            {% endif %}

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right">ุงูููุฏ</th>
                            <th class="px-6 py-3 text-right">ุงููุตู</th>
                            <th class="px-6 py-3 text-right">ุงูุญุงูุฉ</th>
                            <th class="px-6 py-3 text-right">ุนุฏุฏ ุงูุงุณุชุฎุฏุงู</th>
                            <th class="px-6 py-3 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                            <th class="px-6 py-3 text-right">ุฅุฌูุงูู ุงููุจุงูุบ</th>
                            <th class="px-6 py-3 text-right">ุงูุนูููุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="codesList" class="divide-y">
                        {% for code in codes %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium">{{ code.code }}</td>
                            <td class="px-6 py-4">{{ code.description }}</td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 {% if code.status == 'active' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %} rounded-full text-sm">
                                    {{ 'โ ูุดุท' if code.status == 'active' else 'โ ูุชููู' }}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <span class="font-medium">{{ code.used_count }}</span>
                                    {% if code.max_uses > 0 %}
                                    <span class="text-gray-500 text-sm mr-1">/ {{ code.max_uses }}</span>
                                    <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                                        <div class="bg-blue-500 rounded-full h-2" style="width: {{ (code.used_count / code.max_uses * 100)|round|string + '%' }}"></div>
                                    </div>
                                    {% else %}
                                    <span class="text-gray-500 text-sm mr-1">/ โ</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-gray-500">{{ code.created_at }}</td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span class="font-medium">{{ '%0.2f'|format(code.total_usdt|default(0)) }} USDT</span>
                                    <span class="text-sm text-gray-500">{{ '%0.2f'|format(code.total_amount|default(0)) }} USD</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex space-x-2 space-x-reverse">
                                    <button onclick="editCode('{{ code.code }}')" class="text-yellow-500 hover:text-yellow-600 px-2 py-1 rounded">
                                        <span class="text-sm">โ๏ธ ุชุนุฏูู</span>
                                    </button>
                                    {% if code.status == 'active' %}
                                    <button onclick="deactivateCode('{{ code.code }}')" class="text-orange-500 hover:text-orange-600 px-2 py-1 rounded">
                                        <span class="text-sm">๐ซ ุฅููุงู</span>
                                    </button>
                                    {% else %}
                                    <button onclick="activateCode('{{ code.code }}')" class="text-green-500 hover:text-green-600 px-2 py-1 rounded">
                                        <span class="text-sm">โ ุชูุนูู</span>
                                    </button>
                                    {% endif %}
                                    <button onclick="deleteCode('{{ code.code }}')" class="text-red-500 hover:text-red-600 px-2 py-1 rounded">
                                        <span class="text-sm">๐๏ธ ุญุฐู</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ุฅุฏุงุฑุฉ ุฃุณุนุงุฑ ุงูุตุฑู -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">ุฅุฏุงุฑุฉ ุฃุณุนุงุฑ ุงูุตุฑู</h2>
                <button onclick="showAddRateModal()" class="bg-blue-500 text-white px-4 py-2 rounded-md">
                    ุฅุถุงูุฉ ุนููุฉ ุฌุฏูุฏุฉ
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right">ุงูุนููุฉ</th>
                            <th class="px-6 py-3 text-right">ุณุนุฑ ุงูุตุฑู (USDT)</th>
                            <th class="px-6 py-3 text-right">ุขุฎุฑ ุชุญุฏูุซ</th>
                            <th class="px-6 py-3 text-right">ุงูุนูููุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="exchangeRatesList" class="divide-y">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal ุฅุถุงูุฉ/ุชุนุฏูู ุณุนุฑ ุงูุตุฑู -->
        <div id="rateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 id="rateModalTitle" class="text-lg font-bold mb-4">ุฅุถุงูุฉ ุนููุฉ ุฌุฏูุฏุฉ</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">ุฑูุฒ ุงูุนููุฉ</label>
                        <input type="text" id="currencyCode" class="w-full p-2 border rounded-md" placeholder="ูุซุงู: SAR">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ุณุนุฑ ุงูุตุฑู (USDT)</label>
                        <input type="number" id="exchangeRate" class="w-full p-2 border rounded-md" step="0.0001">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideRateModal()" class="px-4 py-2 border rounded-md">ุฅูุบุงุก</button>
                        <button onclick="saveExchangeRate()" class="bg-blue-500 text-white px-4 py-2 rounded-md">ุญูุธ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ุงูุฅุนุฏุงุฏุงุช -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-6">ุงูุฅุนุฏุงุฏุงุช</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">ุงูุญุฏ ุงููุงุตู ููุนูููุฉ ุงูุซุงุจุชุฉ (USDT)</label>
                        <input type="number" id="fixedFeeThreshold" class="w-full p-2 border rounded-md" step="0.1">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ูููุฉ ุงูุนูููุฉ ุงูุซุงุจุชุฉ (USDT)</label>
                        <input type="number" id="fixedFeeAmount" class="w-full p-2 border rounded-md" step="0.1">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ูุณุจุฉ ุงูุนูููุฉ ูููุจุงูุบ ุงููุจูุฑุฉ (%)</label>
                        <input type="number" id="percentageFee" class="w-full p-2 border rounded-md" step="0.1">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ (USDT)</label>
                        <input type="number" id="minWithdrawal" class="w-full p-2 border rounded-md" step="0.1">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ุงูุญุฏ ุงูุฃุนูู ููุณุญุจ (USDT)</label>
                        <input type="number" id="maxWithdrawal" class="w-full p-2 border rounded-md" step="0.1">
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="saveSettings()" class="bg-blue-500 text-white px-6 py-2 rounded-md">
                        ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ุฅุถุงูุฉ/ุชุนุฏูู ููุฏ -->
    <div id="codeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg w-[500px]">
            <h3 id="codeModalTitle" class="text-xl font-bold mb-6">ุฅุถุงูุฉ ููุฏ ุฌุฏูุฏ</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">ุงูููุฏ</label>
                        <input type="text" id="codeInput" class="w-full p-2 border rounded-md" dir="ltr">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ุงูุญุงูุฉ</label>
                        <select id="codeStatus" class="w-full p-2 border rounded-md">
                            <option value="active">ูุดุท</option>
                            <option value="inactive">ูุชููู</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">ุงููุตู</label>
                    <input type="text" id="codeDesc" class="w-full p-2 border rounded-md" placeholder="ูุตู ุงุฎุชูุงุฑู ููููุฏ">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 mb-2">ุงูุญุฏ ุงูุฃูุตู ููุงุณุชุฎุฏุงู</label>
                        <div class="flex items-center">
                            <input type="number" id="codeMaxUses" class="w-full p-2 border rounded-md" min="-1" value="-1">
                            <span class="text-gray-500 text-sm mr-2">(-1 = ุบูุฑ ูุญุฏูุฏ)</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุตูุงุญูุฉ</label>
                        <input type="datetime-local" id="codeExpiry" class="w-full p-2 border rounded-md" dir="ltr">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-2 space-x-reverse">
                    <button onclick="hideCodeModal()" class="px-4 py-2 border rounded-md hover:bg-gray-50">
                        ุฅูุบุงุก
                    </button>
                    <button onclick="saveCode()" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600">
                        <span id="saveCodeButtonText">ุฅุถุงูุฉ</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        async function importCodes(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/import-codes', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                const messageDiv = document.getElementById('importMessage');
                messageDiv.classList.remove('hidden');
                
                if (result.success) {
                    messageDiv.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4';
                    messageDiv.innerHTML = `
                        <strong class="font-bold">ุชู!</strong>
                        <span class="block sm:inline">${result.message}</span>
                        ${result.errors.length > 0 ? `
                            <ul class="list-disc list-inside mt-2">
                                ${result.errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        ` : ''}
                    `;
                    
                    // ุชุญุฏูุซ ุงูุตูุญุฉ ุจุนุฏ ุซุงููุชูู
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    messageDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
                    messageDiv.innerHTML = `
                        <strong class="font-bold">ุฎุทุฃ!</strong>
                        <span class="block sm:inline">${result.error}</span>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชูุฑุงุฏ ุงูููู');
            }
            
            // ุฅุนุงุฏุฉ ุชุนููู ุญูู ุงูููู
            input.value = '';
        }
    </script>
</body>
</html>
